version: '3.8'

services:
  # Caddy - Reverse Proxy with Automatic HTTPS
  caddy:
    image: caddy:2-alpine
    container_name: retailstore_caddy
    restart: unless-stopped
    ports:
      - "3010:80" # Frontend HTTP -> port 3010
      - "3443:443" # Frontend HTTPS -> port 3443
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy-data:/data
      - caddy-config:/config
      - caddy-logs:/var/log/caddy
    environment:
      - CERTBOT_EMAIL=${CERTBOT_EMAIL:-admin@retailos.cloud}
    networks:
      - retailstore-network
    depends_on:
      - web
      - backend

  # Next.js frontend application
  web:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_RETAILOS_DOMAIN=${NEXT_PUBLIC_RETAILOS_DOMAIN:-retailos.cloud}
        - NEXT_PUBLIC_INDUMART_DOMAIN=${NEXT_PUBLIC_INDUMART_DOMAIN:-indumart.us}
        - NEXT_PUBLIC_API_URL=
        - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
        - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    container_name: retailstore_web
    restart: always
    ports:
      - "3011:3000"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_RETAILOS_DOMAIN=${NEXT_PUBLIC_RETAILOS_DOMAIN:-retailos.cloud}
      - NEXT_PUBLIC_INDUMART_DOMAIN=${NEXT_PUBLIC_INDUMART_DOMAIN:-indumart.us}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    env_file:
      - .env.production
    networks:
      - retailstore-network
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # FastAPI backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: retailstore_backend
    restart: always
    ports:
      - "8010:8000" # Backend API -> port 8010
    environment:
      - DATABASE_URL=${DATABASE_URL:-postgresql://retailstore:retailstore@db:5432/retailstore}
      - MASTER_DATABASE_URL=${DATABASE_URL:-postgresql://retailstore:retailstore@db:5432/retailstore}
      - DB_HOST=db
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER:-retailstore}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-retailstore}
      - SECRET_KEY=${JWT_SECRET:-changeme_dev_secret}
      - CORS_ORIGINS=["https://retailos.cloud","https://www.retailos.cloud","https://indumart.us","https://www.indumart.us"]
    env_file:
      - .env.production
    depends_on:
      db:
        condition: service_healthy
    networks:
      - retailstore-network
    healthcheck:
      test: [ "CMD", "python3", "-c", "import requests; requests.get('http://localhost:8000/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL database
  db:
    image: postgres:15-alpine
    container_name: retailstore_db
    restart: always
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-retailstore}
      - POSTGRES_USER=${POSTGRES_USER:-retailstore}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-retailstore}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - retailstore-network
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-retailstore}" ]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  retailstore-network:
    driver: bridge

volumes:
  postgres-data:
  caddy-data:
  caddy-config:
  caddy-logs:
