# Apache configuration for retailOS.cloud
# Place this file in: /etc/apache2/sites-available/retailos.conf
# Then run: sudo a2ensite retailos && sudo a2enmod proxy proxy_http ssl rewrite
# Then run: sudo apache2ctl configtest && sudo systemctl reload apache2

<VirtualHost *:80>
    ServerName retailos.cloud
    ServerAlias *.retailos.cloud

    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName retailos.cloud
    ServerAlias *.retailos.cloud

    # SSL Configuration (update paths after running certbot)
SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/retailos.cloud/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/retailos.cloud/privkey.pem

    # Proxy Configuration
    ProxyPreserveHost On
    ProxyPass / http://localhost:3010/
    ProxyPassReverse / http://localhost:3010/

    # WebSocket Support
    RewriteEngine on
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:3010/$1" [P,L]

    # Headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/retailos_error.log
    CustomLog ${APACHE_LOG_DIR}/retailos_access.log combined
</VirtualHost>
